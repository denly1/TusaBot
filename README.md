# TusaBot

Telegram-бот для управления афишами и мероприятиями с интеграцией VK и PostgreSQL.

## Возможности

- Управление афишами (создание, просмотр, навигация)
- Регистрация пользователей с сохранением в PostgreSQL
- Проверка подписки на Telegram канал и VK группу
- Привязка VK профилей с автопроверкой
- Рассылка афиш в Telegram и VK
- Админ-панель с полной статистикой
- База данных PostgreSQL для хранения всех данных

## Требования
- Python 3.10+
- PostgreSQL 12+
- Токен Telegram бота
- Канал Telegram (публичный) `@largentmsk` и добавленный бот как администратор канала
- (Опционально) VK токен доступа для проверки подписки на группу `vk.com/largent.tusa`

## Установка
1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
2. Создайте файл `.env` в корне проекта (рядом с `bot.py`). Можно использовать `.env.example` как шаблон.

Пример `.env`:
```env
BOT_TOKEN=ваш_токен_бота
ADMIN_USER_ID=123456789
CHANNEL_USERNAME=@largentmsk
# Настройка времени для еженедельной рассылки (локальное MSK, UTC+3)
WEEKLY_DAY=4      # 0=Пн ... 6=Вс; по умолчанию Пт
WEEKLY_HOUR=12    # Час по Москве
WEEKLY_MINUTE=0   # Минуты
# VK интеграция (необязательно)
VK_TOKEN=          # токен доступа VK с правами groups
VK_GROUP_DOMAIN=largent.tusa
```

Примечания:
- Бот должен быть администратором канала `@largentmsk`, иначе Telegram API не даст корректно проверить подписку пользователей.
- Чтобы узнать ваш `ADMIN_USER_ID`, запустите бота и отправьте команду `/id` в личку боту. Вставьте это значение в `.env`.

## Запуск
```bash
python bot.py
```
Бот запустится в режиме `polling`.

## Использование
- Команда `/start` — покажет кнопки:
  - «Проверить подписку»: бот проверит подписку на `@largentmsk`.
  - «Отметиться»: отметит присутствие на текущей неделе (требует подписку).
  - «Получить афишу»: пришлет сохраненную афишу (если админ загрузил).
- Команда `/id` — вернет ваш Telegram ID.

### Команды администратора
- `/save_poster` — отправьте фото афиши с подписью, затем ответьте на это фото командой `/save_poster`. Бот сохранит `file_id` фото и подпись.
- `/broadcast_now` — отправить текущую афишу всем известным пользователям немедленно.
- `/set_ticket <url>` — задать ссылку «Купить билет», которая появится под афишей.
- `/delete_poster` — удалить текущую афишу (можно загрузить новую).
- `/broadcast_text <текст>` — массовая текстовая рассылка всем известным пользователям.

### Еженедельная рассылка
- Время задается через `.env` (поля `WEEKLY_DAY`, `WEEKLY_HOUR`, `WEEKLY_MINUTE`).
- В рассылке бот:
  1) Подводит итоги прошлой недели: тем, кто не отметился, увеличивает счетчик пропусков; при значении > 2 — отправляет сообщение-напоминание.
  2) Рассылает афишу всем пользователям, которые взаимодействовали с ботом (`/start`).

### Интеграция VK: привязка профиля и проверка подписки
- Включите VK-проверку, задав в `.env` переменные `VK_TOKEN` и `VK_GROUP_DOMAIN` (по умолчанию `largent.tusa`).
- Пользователь может привязать свой VK профиль через кнопку «Привязать VK», отправив ссылку вида `https://vk.com/yourid`.
- Кнопка «Проверить подписки» покажет статусы Telegram и VK. Если VK токен не задан или VK API недоступен, статус VK может быть «не удалось проверить».

## Хранение данных
- Используется `PicklePersistence`; файл хранится в `data/bot_data.pkl`.
- Сохраняются: известные пользователи, их недели посещений и счетчик пропусков, сохраненная афиша (`file_id` + подпись).

## Важно
- Чтобы проверка подписки работала, бот должен быть администратором публичного канала `@largentmsk`.
- Если пользователь заблокировал бота, отправка сообщений будет невозможна (ошибка Forbidden). Это логируется, но не приводит к падению бота.

## Советы по Windows
- Если планируете держать бота постоянно запущенным, можно использовать `Task Scheduler` или запускать в screen/tmux на сервере. В dev-режиме достаточно `python bot.py` в отдельном окне.
